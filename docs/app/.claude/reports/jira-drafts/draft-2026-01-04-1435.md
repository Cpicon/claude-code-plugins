# Jira Task Draft

> Generated: 2026-01-04 14:35
> Mode: Fallback (Atlassian MCP unavailable)
> Issue Type: Bug

---

**Summary:** Fix email duplicate validation - off-by-one error allows duplicate email registration

**Description:**

## Problem

Users can register with the same email address multiple times due to an off-by-one error in the email validation logic. This is a **HIGH severity** data integrity issue affecting the user registration endpoint.

## Root Cause

The email duplicate check at `main.py:78` uses `range(0, user_id_counter)` but user IDs start at `1`. This means:
- The first user's email is **never validated** against existing users
- Each subsequent user's email misses validation against the most recent user

```python
# Current buggy code (line 78)
for uid in range(0, user_id_counter):  # Checks [0, 1, ..., N-1] but users are [1, 2, ..., N]
```

## Recommended Solution

Replace the range-based iteration with `.values()` iteration (matching the username validation pattern at lines 71-73):

```python
# Check if email already exists
for existing_user in users_db.values():
    if existing_user["email"] == user.email:
        raise HTTPException(status_code=400, detail="Email already registered")
```

## Implementation Steps

1. **Update email validation logic**
   - File: `main.py`
   - Lines: 75-84
   - Replace range-based loop with `.values()` iteration

2. **Add unit test for regression prevention**
   - File: `tests/test_user_creation.py` (create)
   - Add `test_duplicate_email_rejected()` test case

3. **Manual verification**
   - Create user with email, attempt duplicate registration
   - Should return HTTP 400 with "Email already registered"

## Affected Files

| File | Lines | Change Type |
|------|-------|-------------|
| main.py | 75-84 | Modify |
| tests/test_user_creation.py | new | Create |

## Risk Assessment

- **Risk Level**: LOW (isolated change, clear fix)
- **Rollback**: Simple - revert single function modification
- **Dependencies**: None

---

**Acceptance Criteria:**

- [ ] Duplicate email addresses are rejected with HTTP 400
- [ ] Error message states "Email already registered"
- [ ] First user's email is properly validated (edge case fix)
- [ ] Existing username validation continues to work
- [ ] Unit test added to prevent regression
- [ ] Manual testing confirms fix in local environment

---

**Labels:**

`bug`, `priority:high`, `component:api`, `component:validation`, `type:bugfix`

---

## Manual Creation Instructions

1. Copy the Summary and Description above
2. Create a new issue in your Jira project
3. Set the issue type to: **Bug**
4. Add the labels: `bug`, `priority:high`, `component:api`, `component:validation`, `type:bugfix`
5. Review and adjust priority/assignee as needed

---

## Source Reference

Generated from debugging report: `.claude/reports/debugging/report-2026-01-04-1430.md`
